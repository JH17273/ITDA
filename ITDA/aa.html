<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>오픈 채팅방 리스트</title>
  <link rel="stylesheet" href="/as.css">
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <style>
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header"></header>
    <div class="layout">
      <main class="main-content">

        <!-- ────────── 위치 필터 폼 ────────── -->
        <form id="sortForm" method="get" action="/openchat/openChatList">
          <!-- 1) 시·도 고정 제목 -->
          <div class="location-filter">
            <h4>위치</h4>
            <div class="sido-label">서울특별시</div>
            <!-- TODO: 서버에서 받아온 selectedSido -->
          </div>

          <!-- 2) 시·군·구 라디오 버튼 (선택 즉시 submit) -->
          <div class="sigungu-list">
            <!-- TODO: sigunguList 만큼 아래 라벨 복제 -->
            <label class="sigungu-item">
              <input type="radio" name="sigungu" value="서초구" checked onchange="this.form.submit()">
              <span class="sigungu-label">서초구</span>
            </label>
            <label class="sigungu-item">
              <input type="radio" name="sigungu" value="강남구" onchange="this.form.submit()">
              <span class="sigungu-label">강남구</span>
            </label>
            <!-- ... -->
          </div>

          <!-- 3) 다른 지역 검색 토글 -->
          <div class="other-region">
            <button type="button" id="toggleSidoSelect">다른 지역 검색</button>
          </div>

          <!-- 4) 숨겨진 시·도 선택 박스 (선택 즉시 submit) -->
          <div id="sidoSelectContainer" style="display: none; margin-top: 8px;">
            <select name="sido" id="sidoSelect" onchange="this.form.submit()">
              <option value="">시·도 선택</option>
              <!-- TODO: sidoList 만큼 아래 옵션 복제 -->
              <option value="서울특별시" selected>서울특별시</option>
              <option value="경기도">경기도</option>
              <option value="부산광역시">부산광역시</option>
              <!-- ... -->
            </select>
          </div>
        </form>

        <!-- ────────── 제목 & 위치 표시 ────────── -->
        <h1 class="main-title">오픈 채팅방 리스트</h1>
        <h2 class="location">서울특별시 서초구</h2>
        <!-- TODO: JS getLocation() 으로 자동 채워넣기 -->

        <!-- ────────── 상단 검색/개설 바 ────────── -->
        <div class="top-bar">
          <input type="text" class="search-bar" placeholder="채팅방 검색">
          <button type="button" class="create-chat-btn">채팅방 개설</button>
        </div>

        <!-- ────────── 채팅방 리스트 ────────── -->
        <div class="chat-list-box">
          <!-- TODO: openlist 만큼 아래 카드 복제 -->
          <div class="chat-room">
            <div class="chat-img-box">
              <img src="resources/images/chat/openchat_default.jpg" alt="채팅방 이미지" class="chat-img">
            </div>
            <div class="chat-title">음악 감상 모임</div>
            <div class="chat-tags">#음악 #감상</div>
            <div class="chat-members">참여인원: 3 / 10</div>
            <button type="button" class="join-btn open-detail"
                    data-room-id="1"
                    data-img="resources/images/chat/openchat_default.jpg"
                    data-name="음악 감상 모임"
                    data-tags="음악,감상"
                    data-count="3"
                    data-max="10"
                    data-des="편하게 음악을 듣고 이야기해요.">
              참여하기
            </button>
          </div>
        </div>

        <!-- ────────── 페이지네이션 ────────── -->
        <div class="pagination">
          <button class="page-btn prev">&laquo;</button>
          <button class="page-btn active">1</button>
          <button class="page-btn">2</button>
          <button class="page-btn">3</button>
          <button class="page-btn next">&raquo;</button>
        </div>

        <!-- ────────── 상세 모달 ────────── -->
        <div id="detailModal" class="modal hidden">
          <div class="modal-content">
            <span class="close-btn" id="closeDetailBtn">&times;</span>
            <h2>채팅방 정보</h2>
            <img id="detailImage" class="chat-img" style="width:100%; border-radius:10px;">
            <div class="chat-title" id="detailTitle"></div>
            <div class="chat-tags" id="detailTags"></div>
            <div class="chat-members" id="detailMembers"></div>
            <div class="chat-explanation" id="detailExplanation"
                 style="margin-top:10px; white-space:pre-line; font-size:14px;"></div>
            <div style="text-align:center; margin-top:16px;">
              <form id="enterForm" method="get" action="/chat/enter">
                <input type="hidden" name="roomId" id="roomIdInput">
                <button type="submit" class="submit-btn">입장하기</button>
              </form>
            </div>
          </div>
        </div>

        <!-- ────────── 개설 모달 ────────── -->
        <div id="modal" class="modal hidden">
          <div class="modal-content">
            <span class="close-btn" id="closeModalBtn">&times;</span>
            <h2>오픈 채팅방 개설</h2>
            <form action="/openchat/createOpenChat" method="post" enctype="multipart/form-data" onsubmit="return validateForm(this)">
              <div class="image-upload-area">
                <label class="image-label">이미지 업로드</label>
                <div class="image-preview-box">
                  <div id="previewContainer" style="display:flex;"></div>
                  <button type="button" class="add-image-btn" id="addImageBtn">+</button>
                  <input type="file" id="imageFile" name="openImage" multiple accept="image/*"
                         style="opacity:0; position:absolute; left:-9999px;">
                </div>
              </div>

              <!-- 숨김 필드 -->
              <input type="hidden" id="latitude" name="latitude">
              <input type="hidden" id="longitude" name="longitude">
              <input type="hidden" id="sido" name="sido">
              <input type="hidden" id="sigungu" name="sigungu">

              <!-- 위치 입력 -->
              <div class="form-row">
                <label for="locationText">지역:</label>
                <div style="display:flex; align-items:center; flex:1;">
                  <input type="text" id="locationText" name="locationText"
                         placeholder="위치 불러오는 중..." style="flex:1; margin-right:8px;">
                  <button type="button" onclick="getLocation()" style="margin-right:4px;">새로고침</button>
                  <button type="button" id="editLocationBtn">주소검색</button>
                </div>
              </div>

              <div class="form-row">
                <label for="chatName">제목:</label>
                <input type="text" id="chatName" name="chatName" required>
              </div>
              <div class="form-row">
                <label for="tagContent">태그:</label>
                <input type="text" id="tagContent" name="tagContent" placeholder="#음악 #운동">
              </div>
              <div class="form-row">
                <label for="maxchatCount">최대인원:</label>
                <input type="number" id="maxchatCount" name="maxchatCount" min="1" max="30" value="2">
              </div>
              <label class="details-label" for="explanation">세부사항:</label>
              <textarea id="explanation" name="explanation" rows="6" maxlength="2000" class="details-textarea"></textarea>
              <div style="margin-top:10px; text-align:right;">
                <button type="submit" class="submit-btn" id="submitBtn" disabled>개설하기</button>
              </div>
            </form>
          </div>
        </div>

      </main>
    </div>
  </div>

  <script>
    // contextPath 설정 (필요시 /itda 등으로 변경)
    const contextPath = '';

    // 위치 가져오기
    function getLocation() {
      if (!navigator.geolocation) {
        alert("이 브라우저에서는 위치 정보가 지원되지 않습니다.");
        return;
      }
      navigator.geolocation.getCurrentPosition(success, error, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    function success(position) {
      const lat = position.coords.latitude, lng = position.coords.longitude;
      document.getElementById("latitude").value = lat;
      document.getElementById("longitude").value = lng;

      fetch(`${contextPath}/kakao/reverse?lat=${lat}&lng=${lng}`)
        .then(res => res.ok ? res.json() : Promise.reject(res.status))
        .then(data => {
          const full = data.address || "";
          document.getElementById("locationText").value = full;
          const parts = full.split(" "), sido = parts[0]||"", r2=parts[1]||"", r3=parts[2]||"";
          let sigungu = (r2.endsWith("시")||r2.endsWith("군")) ? `${r2} ${r3}` : r2;
          document.getElementById("sido").value = sido;
          document.getElementById("sigungu").value = sigungu;
          document.querySelector("h2.location").textContent = `${sido} ${sigungu}`.trim();
          document.getElementById("submitBtn").disabled = false;
        })
        .catch(err => {
          console.error("주소 가져오기 실패", err);
          document.getElementById("locationText").value = "주소 오류";
        });
    }
    function error() {
      alert("위치 정보를 가져올 수 없습니다. 위치 권한을 허용해주세요.");
    }

    // 모달 토글
    function showDetailModal(){ document.getElementById("detailModal").classList.remove("hidden"); }
    function hideDetailModal(){
      document.getElementById("detailModal").classList.add("hidden");
      ["detailTags","detailImage","detailTitle","detailMembers","detailExplanation"].forEach(id=>{
        const el = document.getElementById(id);
        if(el.tagName==="IMG") el.src="";
        else el.textContent = "";
      });
      document.getElementById("roomIdInput").value = "";
    }

    document.addEventListener("DOMContentLoaded",()=>{
      // 디테일 모달 이벤트
      document.querySelectorAll(".open-detail").forEach(btn=>{
        btn.addEventListener("click",()=>{
          document.getElementById("detailImage").src = btn.dataset.img;
          document.getElementById("detailTitle").textContent = btn.dataset.name;
          document.getElementById("detailTags").innerHTML = btn.dataset.tags.split(",").map(t=>`<span class="tag">#${t}</span>`).join(" ");
          document.getElementById("detailMembers").textContent = `참여 인원: ${btn.dataset.count} / ${btn.dataset.max}`;
          document.getElementById("detailExplanation").textContent = btn.dataset.des;
          document.getElementById("roomIdInput").value = btn.dataset.roomId;
          showDetailModal();
        });
      });
      document.getElementById("closeDetailBtn").addEventListener("click", hideDetailModal);

      // 개설 모달 이벤트
      const createBtn = document.querySelector(".create-chat-btn"),
            createModal = document.getElementById("modal");
      createBtn.addEventListener("click", ()=>{ createModal.classList.remove("hidden"); getLocation(); });
      document.getElementById("closeModalBtn").addEventListener("click", ()=>createModal.classList.add("hidden"));

      // 이미지 미리보기
      const addImageBtn = document.getElementById('addImageBtn'),
            imageFileInput = document.getElementById('imageFile'),
            previewContainer = document.getElementById('previewContainer');
      addImageBtn.addEventListener("click",()=>imageFileInput.click());
      imageFileInput.addEventListener('change',()=>{
        previewContainer.innerHTML="";
        Array.from(imageFileInput.files).forEach(file=>{
          const reader = new FileReader();
          reader.onload = e=>{
            const img=document.createElement('img');
            img.src=e.target.result;
            img.classList.add('preview-img');
            previewContainer.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });

      // “다른 지역 검색” 토글
      const toggleBtn = document.getElementById('toggleSidoSelect'),
            container = document.getElementById('sidoSelectContainer');
      toggleBtn.addEventListener('click', ()=>{
        const hidden = container.style.display==="none";
        container.style.display = hidden? "block":"none";
        toggleBtn.textContent = hidden? "검색 영역 접기":"다른 지역 검색";
      });
    });

    // 개설 폼 유효성
    function validateForm(f){
      if(!f.sido.value||!f.sigungu.value){
        alert("지역을 선택해주세요.");
        return false;
      }
      return true;
    }
  </script>
</body>
</html>
