<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chat">

<!-- ==================== 채팅방 검색 ==================== 
		- 거래 채팅방
		- 오픈 채팅방
-->
		<!-- SELECT CHAT_ROOM_NUM, TITLE, USER_NAME, (SELECT COUNT(*)
												FROM CHAT_PARTICIPANT CRJ
												WHERE CRJ.CHAT_ROOM_NO = CR.CHAT_ROOM_NO )
		FROM CHAT_ROOM CR
			LEFT JOIN USER_TB USING(USER_NUM)
		WHERE CR.STATUS = 'Y'
		ORDER BY CHATROOM_ID DESC -->
		<!-- 살아있는 채팅방에 한해 채팅방 번호 기준 내림차순 -->

<!-- 채팅방 검색 -->
<!-- 접속한 회원이 현재 대화하고 있는 채팅방 리스트 검색 -->
	<select id="selectChatRoomList" resultType="chatRoom">
	SELECT
        CR.CHATROOM_ID,
		U.USER_NUM,
		TC.BOARD_ID,
		CR.STATUS,
        CR.REF_NUM,
        OC.OPEN_CHAT_ROOM_NAME
		
	FROM CHAT_ROOM CR
	LEFT JOIN TRANSACTION_CHAT TC ON CR.CHATROOM_ID = TC.CHATROOM_ID
    LEFT JOIN OPEN_CHAT OC ON CR.CHATROOM_ID = OC.CHATROOM_ID 
	LEFT JOIN BOARD_COMMON BC ON TC.BOARD_ID = BC.BOARD_ID
	LEFT JOIN USER_TB U ON CR.USER_NUM = U.USER_NUM
	INNER JOIN CHAT_PARTICIPANT CP ON CR.CHATROOM_ID = CP.CHATROOM_ID
	
	WHERE CR.STATUS = 'Y'
	  AND CP.USER_NUM = 1 
	ORDER BY CR.CHATROOM_ID DESC
	</select>
	
	
<!-- ==================== 채팅방 생성 ==================== -->
	<!-- 채팅룸 생성 종류
		- OPENCHAT
		- TRANSACTIONCHAT
	-->
	<!-- 
	CHAT_ROOM (채팅방 - 공통)
		- CHATROOM_ID
		- USER_NUM
		- REF_NUM
		- STATUS
	
	OPEN_CHAT (CHAT_ROOM => 오픈 채팅방)
		- CHATROOM_ID
		- OPEN_CHAT_ROOM_NAME
		- OPEN_CHAT_COUNT
		- MAX_CHATROOM_COUNT
		- DESCRIPTION
	
	TRANSACTION_CHAT (CHAT_ROOM => 거래 채팅방)
		- CHATROOM_ID
		- BOARD_ID	
	 -->
	 
	<!-- 오픈 채팅방 생성 -->
		<!-- 오픈채팅방 용도
		채팅방 번호, 회원 번호, 채팅방 종류(나눔, 대여, 경매 등), 채팅방 상태,
		오픈 채팅방 이름, 오픈 채팅방 참여인원, 최대 참여 인원, 세부 사항
		-->
	<!-- <insert id = "createOpenChat">
		INSERT INTO CHAT_ROOM (CHATROOM_ID, USER_NUM, REF_NUM, STATUS)
		VALUES
		(SEQ_CR_NO.NEXTVAL, #{userNum}, #{refNum}, DEFAULT)
		
		INSERT INTO OPEN_CHAT (
			CHATROOM_ID,
			OPEN_CHAT_ROOM_NAME,
			OPEN_CHAT_COUNT,
			MAX_CHATROOM_COUNT,
			DESCRIPTION
		) VALUES (
			#{chatRoomId},
			#{openChatRoomName},
			#{openChatCount},
			#{maxChatRoomCount},
			#{description}
		)
	</insert> -->
	
	<!-- 거래 채팅방 생성 -->
	<insert id = "openChatRoom">
		INSERT INTO CHAT_ROOM (CHATROOM_ID, USER_NUM, REF_NUM, STATUS)
		VALUES (
		SEQ_CR_NO.NEXTVAL, 
		#{userNum}, 
		#{refNum}, 
		DEFAULT)
		<!-- 채팅방 번호, 회원 번호, 채팅방 종류(나눔, 대여, 경매 등) -->	
			
		INSERT INTO TRANSACTION_CHAT (
			CHATROOM_ID,
			BOARD_ID
		) VALUES (
			#{chatRoomId}, 
			#{boardId})
		<!-- 채팅방 상태, 게시물 Id => BOARD_COMMON의 BOARD_ID 참조 -->
	</insert>
	
	
<!-- ==================== 채팅방 참여 여부 검색 ====================
-->
	<select id="joinCheck" resultType="int">
		SELECT COUNT(*) FROM CHAT_PARTICIPANT
		WHERE CHAT_ROOM_ID = #{chatRoomId}
			AND USER_NUM = #{userNum}
	</select>
	
	
<!-- ==================== 채팅방 참여 ==================== -->
	<!-- 채팅방 참여 
			- CHATROOM_ID
			- USER_NUM
	-->
	<insert id="joinChatRoom">
		INSERT INTO CHAT_PARTICIPANT VALUES
		(#{chatRoomId}, #{userNum})
	</insert>


<!-- ==================== 메세지 DB에서 끌어옴 ==================== -->
	<select id="selectChatMessage" resultType="chatMessage">
		SELECT
			MESSAGE_ID,
			CHATROOM_ID,
			SENT_AT,
			CHAT_CONTENT
		FROM CHAT_MESSAGE
		LEFT JOIN CHAT_ROOM USING(CHATROOM_ID)
		WHERE CHATROOM_ID = #{chatRoomId}
		ORDER BY MESSAGE_ID
	</select>


<!-- ==================== 메세지 DB 삽입 ==================== -->	
	<insert id="insertMessage">
		INSERT INTO CHAT_MESSAGE
		<!-- 
			MESSAGE_ID,
			CHATROOM_ID (CHAT_ROOM 참조),
			SENT_AT,
			CHAT_CONTENT
		 -->
		VALUES (
			SEQ_CM_NO.NEXTVAL,
			#{chatRoomId},
			SYSDATE,
			#{chatContent}
		)
	</insert>


<!-- ==================== 채팅방 나가기 ==================== -->	
	<!-- 접속한 회원 기준 채팅방 없앰 -->
	<delete id="exitChatRoom">
		DELETE FROM CHAT_PARTICIPANT
		WHERE CHATROOM_ID = #{chatRoomId} AND
			USER_NUM = #{userNum}
	</delete>

	
<!-- ==================== 채팅방 참여중인 회원 수 세기 ==================== -->
	<select id="countChatRoomMember" resultType="int">
		SELECT COUNT(*)
		FROM CHAT_ROOM	
		WHERE CHATROOM_ID = #{chatRoomId}
	</select>


<!-- ==================== 채팅방 닫기 ==================== -->	
	<update id="closeChatRoom">
		UPDATE CHAT_ROOM SET
		STATUS = 'N'
		WHERE CHATROOM_ID = #{chatRoomId}
	</update>
</mapper>