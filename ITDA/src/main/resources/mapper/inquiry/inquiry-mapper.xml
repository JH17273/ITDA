<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="inquiry">

	<!-- 1. 문의글 삽입 -->
	<insert id="insertInquiry"
		parameterType="com.kh.itda.support.model.vo.Inquiry">
		INSERT INTO INQUIRY (
		CS_NUM,
		USER_NUM,
		CS_TITLE,
		CS_CONTENT,
		CS_DATE,
		STATUS,
		CATEGORY_ID,
		CATEGORY_NAME
		) VALUES (
		INQUIRY_SEQ.NEXTVAL,
		#{userNum},
		#{csTitle},
		#{csContent},
		SYSDATE,
		'접수',
		#{categoryId},
		#{categoryName}
		)
	</insert>

	<!-- 2. 문의글 상세 조회 -->
	<select id="selectInquiryById" parameterType="int"
		resultType="com.kh.itda.support.model.vo.Inquiry">
		SELECT * FROM INQUIRY WHERE CS_NUM = #{csNum}
	</select>

	<!-- 3. 문의글 답변 등록 -->
	<update id="updateInquiryReply"
		parameterType="com.kh.itda.support.model.vo.Inquiry">
		UPDATE INQUIRY
		SET CS_REPLY = #{csReply},
		CS_REPLY_DATE =
		SYSDATE
		WHERE CS_NUM = #{csNum}
	</update>

	<!-- 4. 문의글 상태 변경 -->
	<update id="updateInquiryStatus"
		parameterType="com.kh.itda.support.model.vo.Inquiry">
		UPDATE INQUIRY
		SET STATUS = #{status}
		WHERE CS_NUM =
		#{csNum}
	</update>

	<!-- 5. 문의글 전체 목록 조회 -->
	<select id="selectAllInquiries"
		resultType="com.kh.itda.support.model.vo.Inquiry">
		SELECT * FROM INQUIRY ORDER BY CS_DATE DESC
	</select>

	<!-- 6. 사용자 번호로 문의글 목록 조회 -->
	<select id="selectInquiriesByUser" parameterType="int"
		resultType="com.kh.itda.support.model.vo.Inquiry">
		SELECT * FROM INQUIRY WHERE USER_NUM = #{userNum} ORDER BY
		CS_DATE DESC
	</select>

	<!-- 7. 첨부파일 목록 조회 -->
	<select id="selectFilesByRefAndCategory"
		resultType="com.kh.itda.common.model.vo.File">
		SELECT *
		FROM "FILE"
		WHERE ref_no = #{refNo}
		AND category_id = #{categoryId}
	</select>

	<!-- 8. 첨부파일 저장 -->
	<insert id="insertFile"
		parameterType="com.kh.itda.common.model.vo.File">
		<selectKey keyProperty="refNo" resultType="int"
			order="BEFORE">
			SELECT INQUIRY_SEQ.CURRVAL FROM DUAL
		</selectKey>
		INSERT INTO "FILE" (
		FILE_ID,
		CATEGORY_ID,
		FILE_NAME,
		REF_NO
		) VALUES (
		FILE_SEQ.NEXTVAL,
		#{categoryId},
		#{fileName},
		#{refNo}
		)
	</insert>

	<!-- 9. CATEGORY_ID로 CATEGORY_PATH 조회 -->
	<select id="selectCategoryPathById" parameterType="int"
		resultType="string">
		SELECT CATEGORY_PATH
		FROM CATEGORY
		WHERE CATEGORY_ID =
		#{categoryId}
	</select>

	<select id="selectNickNameByUserNum" parameterType="int"
		resultType="string">
		SELECT NICK_NAME FROM USER_TB WHERE USER_NUM = #{userNum}
	</select>

</mapper>