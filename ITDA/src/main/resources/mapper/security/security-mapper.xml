<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="security">

	<select id="loadUserByUsername" resultMap="userResultMap">
		SELECT U.*,
		P.IMAGE_URL
		FROM USER_TB U
		LEFT JOIN PROFILE USING(USER_NUM)
		WHERE
		USER_ID = #{userId}
	</select>

	<select id="getAllReports" resultType="com.kh.itda.support.model.vo.Report">
		SELECT
		REPORT_NUM AS reportNum,
		USER_NUM AS userNum,
		TYPE AS type,
		TARGET_ID AS targetId,
		REASON AS reason,
		DETAIL_REASON AS detailReason,
		STATUS AS status,
		CREATED_AT AS createdAt,
		PROCESSED_AT AS processedAt
		FROM REPORT
		ORDER BY REPORT_NUM DESC
	</select>

	<select id="searchUsers" parameterType="String"
		resultType="user">
		SELECT USER_NUM, USER_ID, NICK_NAME, EMAIL, IMAGE_URL
		FROM
		USER_TB
		LEFT JOIN PROFILE USING(USER_NUM)
		WHERE USER_ID LIKE CONCAT('%',
		#{keyword}, '%')
		OR NICK_NAME LIKE CONCAT('%', #{keyword}, '%')
	</select>

	<!-- 아이디 중복 체크 -->
	<select id="idCheck" resultType="int" parameterType="String">
		SELECT
		COUNT(*) FROM USER_TB WHERE USER_ID = #{userId}
	</select>

	<resultMap type="userExt" id="userResultMap">
		<id column="USER_NUM" property="userNum" />
		<result column="USER_ID" property="userId" />
		<result column="USER_PWD" property="userPwd" />
		<result column="NICK_NAME" property="nickName" />
		<result column="EMAIL" property="email" />
		<result column="PHONE" property="phone" />
		<result column="BIRTH" property="birth" />
		<result column="ADDRESS" property="address" />
		<result column="CREATE_DATE" property="createDate" />
		<result column="IMAGE_URL" property="imageUrl" />
		<collection property="authorities" javaType="arraylist"
			ofType="org.springframework.security.core.authority.SimpleGrantedAuthority"
			column="USER_ID" select="selectAuthorities" />
	</resultMap>

	<select id="selectAuthorities"
		resultType="org.springframework.security.core.authority.SimpleGrantedAuthority">
		SELECT AUTHORITY
		FROM AUTHORITIES
		WHERE USER_NUM = (SELECT
		USER_NUM FROM USER_TB WHERE USER_ID = #{userId})
	</select>


</mapper>